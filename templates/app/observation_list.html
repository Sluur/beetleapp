{% extends 'base.html' %}
{% block title %}Mis observaciones{% endblock %}

{% block content %}
  <h1>Mis observaciones</h1>

  <div id="map" style="height:360px; margin:12px 0;"></div>

  {{ points|json_script:"points-data" }}

  {% if observations %}
    <ul>
      {% for o in observations %}
        <li>
          <strong>{{ o.date }}</strong> — ({{ o.latitude }}, {{ o.longitude }}) — {{ o.place_text }}
          {% if o.photo %}<br><img src="{{ o.photo.url }}" style="max-height:120px">{% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No tenés observaciones todavía.</p>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  // lee los datos inyectados
  const el = document.getElementById('points-data');
  const points = el ? JSON.parse(el.textContent) : [];
  console.log('points:', points); // debug: verifica que hay datos

  // centro por defecto (Salta)
  let center = [-24.7829, -65.4232];
  if (points.length) center = [points[0].lat, points[0].lng];

  // crea mapa
  const map = L.map('map').setView(center, points.length ? 12 : 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

  const bounds = L.latLngBounds();
  points.forEach(p => {
    const m = L.marker([p.lat, p.lng]).addTo(map);
    const img = p.photo ? `<br><img src="${p.photo}" style="max-height:100px">` : '';
    m.bindPopup(`<strong>${p.date}</strong><br>${p.place || ''}${img}`);
    bounds.extend([p.lat, p.lng]);
  });
  if (points.length > 1) map.fitBounds(bounds.pad(0.2));
</script>
{% endblock %}
